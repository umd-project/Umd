import"./zip.min.js";zip.configure({useWebWorkers:!0});export default class Umd{constructor(){this._zip=new zip.TextReader,this._umlname="contents.uml",this._components=[],this._umlcontents="",this._filename="untitled.umd",this._password="",this._readonly=!1,this._isEdited=!0,this._hasChanged=!1}get filename(){return this._filename}set filename(n){const _arr=n.split(".");this._filename=`${_arr[0]}.umd`}set password(p){this._password=p}get readonly(){return this._readonly}set readonly(bool){this._readonly=bool}get isEdited(){return this._isEdited}set isEdited(bool){this._isEdited=bool}get hasChanged(){return this._hasChanged}set hasChanged(bool){this._hasChanged=bool,this.listener(this)}listener(val){}registerListener(fn){this.listener=fn}get elements(){return this._generateElements()}async openFile(fileobj,password){return fileobj?(fileobj.name?this._filename=fileobj.name:this._filename="untitled.umd",password&&(this._password=password),new Promise(async(resolve,reject)=>{try{this._zip=new zip.ZipReader(new zip.BlobReader(fileobj),{password:this._password});const _list=await this._zip.getEntries();let _umlele;this._umlcontents="";let _includearr=[];for(const _ele of _list){const _ext=_ele.filename.split(".").pop().toLowerCase();if("uml"==_ext)_umlele=_ele,this._umlcontents=await _ele.getData(new TextWriter),_includearr.push({filename:_ele.filename,contents:this._umlcontents});else{const _array=await _ele.getData(new Uint8ArrayWriter);_includearr.push({filename:_ele.filename,contents:_array})}}_umlele||reject("invalid-umd"),this._umlcontents||reject("invalid umd");const _dom=this._stringToHTML(this._umlcontents),_ro=_dom.querySelector("uml").getAttribute("data-readonly");this._readonly=!!_ro&&JSON.parse(_ro);const _eles=_dom.querySelector("uml").querySelectorAll("*");this._components=[],_eles.forEach(_ele=>{let _jsn={};if(_jsn.no=this._components.length+1,_jsn.name=_ele.tagName.toLowerCase(),_jsn.data={source:_ele.getAttribute("data-source"),content:_ele.getAttribute("data-content")},_ele.getAttribute("data-aspect")&&(_jsn.data.aspect=_ele.getAttribute("data-aspect")),"include"==_jsn.data.source){const _ind=_includearr.findIndex(ele=>ele.filename==_ele.getAttribute("data-content"));if(-1!=_ind){const _arraybuffer=_includearr[_ind].contents;_jsn.data.arraybuffer=_arraybuffer}this._components.push(_jsn)}else this._components.push(_jsn)}),this._isEdited=!1,this.hasChanged=!1,resolve("")}catch(err){console.log(err),reject("password-required")}})):Promise.reject("invalid-file")}appendComponent(component){return new Promise(async resolve=>{let _jsn={};if(_jsn.no=this._components.length+1,_jsn.name=component.name,_jsn.data={},_jsn.data.source=component.source,_jsn.data.content=component.content,component.aspect&&(_jsn.data.aspect=component.aspect),"include"==_jsn.data.source&&component.file){const _filebuffer=await this._readBuffer(component.file),_arr=new Uint8Array(_filebuffer);_jsn.data.arraybuffer=_arr,this._components.push(_jsn)}else this._components.push(_jsn);this.hasChanged=!0,resolve(_jsn.no)})}editComponent(component){return new Promise(async resolve=>{const _jsn=this._components[component.no-1];if(_jsn.data.source=component.source,_jsn.data.content=component.content,"include"==_jsn.data.source&&component.file){const _filebuffer=await this._readBuffer(component.file),_arr=new Uint8Array(_filebuffer);_jsn.data.arraybuffer=_arr}this.hasChanged=!0,resolve()})}moveComponent(no,direction){const n=no;let s=n;if("U"==direction){if(1==n)return;s=n-1;const nindex=this._components.findIndex(component=>component.no==n),sindex=this._components.findIndex(component=>component.no==s);this._components[nindex].no=s,this._components[sindex].no=n}else if("D"==direction){if(n==this._components.length)return;s=n+1;const nindex=this._components.findIndex(component=>component.no==n),sindex=this._components.findIndex(component=>component.no==s);this._components[nindex].no=s,this._components[sindex].no=n}this.hasChanged=!0,this._components.sort((function(a,b){return a.no-b.no}))}deleteComponent(no){const nindex=this._components.findIndex(component=>component.no==no);-1!=nindex&&(this._components.no=0),this._components.forEach(_component=>{_component.no>no&&_component.no--}),delete this._components[nindex],this.hasChanged=!0,this._components=this._components.filter((function(el){return null!=el}))}async save(){return new Promise(async resolve=>{const _blobWriter=new zip.BlobWriter("application/zip");this._zip=new zip.ZipWriter(_blobWriter,{password:this._password}),this._generateUml(),await this._zip.add("contents.uml",new zip.TextReader(this._umlcontents)),this._components.sort((function(a,b){return a.no-b.no}));for(let i=0;i<this._components.length;i++){const _component=this._components[i];"include"==_component.data.source&&await this._zip.add(_component.data.content,new zip.Uint8ArrayReader(_component.data.arraybuffer))}await this._zip.close();const _blob=await _blobWriter.getData(),file=new File([_blob],this._filename);this.isEdited=!1,this.hasChanged=!1,resolve(file)})}_readBuffer(file){return new Promise(resolve=>{var fr=new FileReader;fr.onload=function(event){resolve(event.target.result)},fr.readAsArrayBuffer(file)})}_readBlobAsText(blob){return new Promise(resolve=>{var fr=new FileReader;fr.onload=function(event){resolve(event.target.result)},fr.readAsText(blob)})}_generateUml(){this._components.sort((function(a,b){return a.no-b.no}));let _str=`<uml data-type="umd" data-readonly="${this._readonly}">`;for(let i=0;i<this._components.length;i++){const _component=this._components[i],_name=_component.name,_data=_component.data;_str+=`<${_name}`,_data.source&&(_str+=` data-source="${_data.source}"`),_data.source,_str+=` data-content="${_data.content}"`,_data.aspect&&(_str+=` data-aspect="${_data.aspect}"`),_str+=`></${_name}>`}_str+="</uml>",this._umlcontents=_str}_generateElements(){let _eles=[];return this._components.sort((function(a,b){return a.no-b.no})),this._components.forEach(_component=>{const _ele=document.createElement(_component.name);switch(_ele.setAttribute("data-no",_component.no),_ele.setAttribute("data-source",_component.data.source),_component.data.aspect&&_ele.setAttribute("data-aspect",_component.data.aspect),_component.data.content&&_ele.setAttribute("data-content",_component.data.content),_component.data.source){case"embed":_ele.setAttribute("data-url",_component.data.content);break;case"include":if(_component.data.arraybuffer){const _blob=new Blob([_component.data.arraybuffer]),_eleurl=URL.createObjectURL(_blob);_ele.setAttribute("data-url",_eleurl)}else _ele.setAttribute("data-url",_component.data.url)}_eles.push(_ele)}),_eles}_support(){if(!window.DOMParser)return!1;var parser=new DOMParser;try{parser.parseFromString("x","text/html")}catch(err){return!1}return!0}_stringToHTML(str){var parser,doc;if(this._support)return(new DOMParser).parseFromString(str,"text/html").body;var dom=document.createElement("div");return dom.innerHTML=str,dom}}